<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music to Blockly</title>
    <script type="module" src="BlocklyJsonFunctions.js"></script>
</head>

<body>
    <form id="test-flatjson">
        <textarea name="flatjson" id="flatjson"></textarea>
        <button type="submit">Test!</button>
    </form>
    <div id="flatContainer"></div>
    <div id="blocklyContainer"></div>
    <script src="https://prod.flat-cdn.com/embed-js/v2.4.0/embed.min.js"></script>
    <script type="module">
        import { threeNotes, flatJsonToBlockly } from './flatJsonToBlockly.js';
        import { generateBlocklyJson, convertFlatJsonToMeasures, updateFlatJsonNotes, parseBlocklyJSON } from './BlocklyJsonFunctions.js';

        document.getElementById('test-flatjson').addEventListener('submit', (e) => {
            e.preventDefault();
            const flatJson = JSON.parse(document.getElementById('flatjson').value);
            const container = document.getElementById('flatContainer');
            const embed = new Flat.Embed(container, {
                score: 'blank',
                "embedParams": {
                    "appId": "60a51c906bcde01fc75a3ad0"
                }
            });
            embed.ready().then(() => {
                return embed.loadJSON(flatJson)
            }).catch((error) => {
                console.error(error);
            });
            // const blocklyJson = flatJsonToBlockly(flatJson);
            // console.log(blocklyJson);  // You can now use this data to create Blockly blocks

        });

        // const blocklyJson = flatJsonToBlockly(threeNotes);
        // console.log(blocklyJson);  // You can now use this data to create Blockly blocks

        // Example usage:

        let flatJSON =
        {
            "score-partwise": {
                "$version": "3.1",
                "part-list": {
                    "score-part": [
                        {
                            "part-name": "Piano",
                            "voiceMapping": {
                                "0": [
                                    0
                                ]
                            },
                            "staffMapping": [
                                {
                                    "mainVoiceIdx": 0,
                                    "voices": [
                                        0
                                    ],
                                    "staffUuid": "9e40a0e8-9da1-2b16-7990-bd40535b053c"
                                }
                            ],
                            "voiceIdxToUuidMapping": {
                                "0": "cdbee2bf-4377-2d9c-9376-ecc23ddc9a58"
                            },
                            "voiceUuidToIdxMapping": {
                                "cdbee2bf-4377-2d9c-9376-ecc23ddc9a58": 0
                            },
                            "part-abbreviation": "Pno.",
                            "score-instrument": {
                                "instrument-name": "Piano",
                                "$id": "P1-I1"
                            },
                            "midi-instrument": {
                                "midi-program": 1,
                                "volume": "100",
                                "$id": "P1-I1",
                                "midi-channel": "1"
                            },
                            "$id": "P1",
                            "uuid": "c3542208-3d69-bc97-7e45-ba83f61a8c49"
                        }
                    ]
                },
                "measure-list": {
                    "score-measure": [
                        {
                            "uuid": "398f678a-9271-b099-00ae-2cf5c09a248b"
                        },
                        {
                            "uuid": "c1042860-5228-ffe4-c23a-8605fda418db"
                        },
                        {
                            "uuid": "e3767c82-cf51-ba4f-abb4-30c1153e4664"
                        },
                        {
                            "uuid": "0555100b-282c-5c59-1ec0-80220b6ca272"
                        }
                    ]
                },
                "part": [
                    {
                        "measure": [
                            {
                                "note": [
                                    {
                                        "staff": "1",
                                        "voice": "1",
                                        "duration": "4",
                                        "pitch": {
                                            "octave": "4",
                                            "step": "E"
                                        },
                                        "$adagio-location": {
                                            "timePos": 0
                                        },
                                        "type": "whole"
                                    }
                                ],
                                "harmony": [],
                                "$number": "1",
                                "attributes": [
                                    {
                                        "divisions": "1",
                                        "time": {
                                            "beats": "4",
                                            "beat-type": "4"
                                        },
                                        "clef": {
                                            "sign": "G",
                                            "line": "2"
                                        },
                                        "key": {
                                            "fifths": "0"
                                        },
                                        "staff-details": {
                                            "staff-lines": "5"
                                        },
                                        "$adagio-time": {
                                            "beats": "4",
                                            "beat-type": "4"
                                        },
                                        "noteBefore": -1,
                                        "$adagio-location": {
                                            "timePos": 0,
                                            "dpq": 1
                                        }
                                    }
                                ],
                                "sound": [
                                    {
                                        "$adagio-swing": {
                                            "swing": false
                                        },
                                        "noteBefore": -1,
                                        "$adagio-location": {
                                            "timePos": 0,
                                            "dpq": 1
                                        }
                                    },
                                    {
                                        "$tempo": "80",
                                        "noteBefore": -1,
                                        "$adagio-location": {
                                            "timePos": 0,
                                            "dpq": 1
                                        }
                                    }
                                ],
                                "direction": [
                                    {
                                        "$placement": "above",
                                        "staff": "1",
                                        "$adagio-location": {
                                            "timePos": 0
                                        },
                                        "direction-type": {
                                            "metronome": {
                                                "per-minute": "80",
                                                "beat-unit": "quarter"
                                            }
                                        },
                                        "noteBefore": -1,
                                        "$adagio-isFirst": true
                                    }
                                ],
                                "$adagio-beatsList": [
                                    1,
                                    1,
                                    1,
                                    1
                                ],
                                "$adagio-restsInsideBeams": false
                            },
                            {
                                "note": [
                                    {
                                        "staff": "1",
                                        "voice": "1",
                                        "duration": "4",
                                        "pitch": {
                                            "octave": "4",
                                            "step": "F"
                                        },
                                        "$adagio-location": {
                                            "timePos": 0
                                        },
                                        "type": "whole"
                                    }
                                ],
                                "harmony": [],
                                "$number": "2",
                                "attributes": [
                                    {
                                        "$adagio-time": {
                                            "beats": "4",
                                            "beat-type": "4"
                                        },
                                        "noteBefore": -1,
                                        "$adagio-location": {
                                            "timePos": 0,
                                            "dpq": 1
                                        }
                                    }
                                ],
                                "$adagio-beatsList": [
                                    1,
                                    1,
                                    1,
                                    1
                                ],
                                "$adagio-restsInsideBeams": false
                            },
                            {
                                "note": [
                                    {
                                        "staff": "1",
                                        "voice": "1",
                                        "duration": "4",
                                        "pitch": {
                                            "octave": "4",
                                            "step": "A"
                                        },
                                        "$adagio-location": {
                                            "timePos": 0
                                        },
                                        "type": "whole"
                                    }
                                ],
                                "harmony": [],
                                "$number": "3",
                                "attributes": [
                                    {
                                        "$adagio-time": {
                                            "beats": "4",
                                            "beat-type": "4"
                                        },
                                        "noteBefore": -1,
                                        "$adagio-location": {
                                            "timePos": 0,
                                            "dpq": 1
                                        }
                                    }
                                ],
                                "$adagio-beatsList": [
                                    1,
                                    1,
                                    1,
                                    1
                                ],
                                "$adagio-restsInsideBeams": false
                            },
                            {
                                "note": [
                                    {
                                        "rest": {},
                                        "voice": "1",
                                        "staff": "1",
                                        "duration": "4",
                                        "$adagio-location": {
                                            "timePos": 0
                                        },
                                        "type": "whole"
                                    }
                                ],
                                "barline": {
                                    "$location": "right",
                                    "bar-style": "light-heavy",
                                    "$adagio-location": {
                                        "dpq": 1,
                                        "timePos": 4
                                    },
                                    "noteBefore": 0
                                },
                                "harmony": [],
                                "$number": "4",
                                "attributes": [
                                    {
                                        "$adagio-time": {
                                            "beats": "4",
                                            "beat-type": "4"
                                        },
                                        "noteBefore": -1,
                                        "$adagio-location": {
                                            "timePos": 0,
                                            "dpq": 1
                                        }
                                    }
                                ],
                                "$adagio-beatsList": [
                                    1,
                                    1,
                                    1,
                                    1
                                ],
                                "$adagio-restsInsideBeams": false
                            }
                        ],
                        "$id": "P1",
                        "uuid": "c3542208-3d69-bc97-7e45-ba83f61a8c49"
                    }
                ],
                "defaults": {
                    "scaling": {
                        "millimeters": "7",
                        "tenths": "40"
                    },
                    "page-layout": {
                        "page-height": "1596.5714285714287",
                        "page-width": "1233.7142857142858",
                        "page-margins": {
                            "$type": "both",
                            "top-margin": "38.857142857142854",
                            "bottom-margin": "38.857142857142854",
                            "left-margin": "38.857142857142854",
                            "right-margin": "38.857142857142854"
                        }
                    },
                    "system-layout": {
                        "system-distance": "115.2"
                    },
                    "staff-layout": {
                        "staff-distance": "72.57142857142857"
                    },
                    "$adagio-measureNumberingStart": 1,
                    "word-font": {
                        "$font-family": "Century Schoolbook L"
                    }
                },
                "$adagio-formatVersion": 60,
                "credit": [
                    {
                        "credit-type": "title",
                        "credit-words": "3 notes"
                    }
                ],
                "work": {
                    "work-title": "3 notes"
                },
                "identification": {
                    "encoding": {
                        "software": "Flat",
                        "encoding-date": "2025-02-24"
                    },
                    "source": "https://flat.io/score/67bcb6fe61f27a0a88a4db86-3-notes?sharingKey=9ef465415e0c8f77bddd388d56599f5ee6b8e553e9ea94b59c8bf2a724e37ed5cd897ee700005fe209bd889d571205755bdc1b675e5d397eaf5f69d9cf9e3ed0"
                }
            }
        }
        // const measures = convertFlatJsonToMeasures(flatJSON);
        const measures = [
            [
                {
                    "duration": "half",
                    "step": "E",
                    "octave": "4"
                }
            ],
            [
                {
                    "duration": "whole",
                    "step": "G",
                    "octave": "4"
                }
            ],
            [
                {
                    "duration": "half",
                    "step": "A",
                    "octave": "3"
                }
            ],
            [
                {
                    "duration": "whole",
                    "step": "rest",
                    "octave": "rest"
                }
            ]
        ]

        const blocklyJson = {
            "blocks": {
                "languageVersion": 0,
                "blocks": [
                    {
                        "type": "measure",
                        "id": "jtUE5{}`UmhqAW(`-s+e",
                        "x": 50,
                        "y": 0,
                        "inputs": {
                            "NOTES": {
                                "block": {
                                    "type": "play_sound",
                                    "id": "JT;odgJ.8uTsq-d~;BoT",
                                    "fields": {
                                        "DURATION": "whole",
                                        "STEP": "E",
                                        "OCTAVE": "4"
                                    }
                                }
                            }
                        },
                        "next": {
                            "block": {
                                "type": "measure",
                                "id": "^ca?KzmS?cVqd;AN/0n8",
                                "inputs": {
                                    "NOTES": {
                                        "block": {
                                            "type": "play_sound",
                                            "id": "Hrx4E]trx:bK:bXBSBQn",
                                            "fields": {
                                                "DURATION": "whole",
                                                "STEP": "F",
                                                "OCTAVE": "4"
                                            }
                                        }
                                    }
                                },
                                "next": {
                                    "block": {
                                        "type": "measure",
                                        "id": "M^k0k=yVY_%@P|G$c)73",
                                        "inputs": {
                                            "NOTES": {
                                                "block": {
                                                    "type": "play_sound",
                                                    "id": "3tY6OMqOEz@I=[UKQR0f",
                                                    "fields": {
                                                        "DURATION": "whole",
                                                        "STEP": "A",
                                                        "OCTAVE": "4"
                                                    }
                                                }
                                            }
                                        },
                                        "next": {
                                            "block": {
                                                "type": "measure",
                                                "id": "JAX4./[vj*RS+jP|kxEZ",
                                                "inputs": {
                                                    "NOTES": {
                                                        "block": {
                                                            "type": "play_sound",
                                                            "id": "_-rSr^l#+;p]q8l[T2Hw",
                                                            "fields": {
                                                                "DURATION": "whole",
                                                                "STEP": "rest",
                                                                "OCTAVE": "rest"
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                ]
            }
        }

        // console.log(generateBlocklyJson(measures));
        // let measures = parseBlocklyJSON(blocklyJson);
        console.log(measures);
        console.log(flatJSON);
        console.log(updateFlatJsonNotes(flatJSON, measures));
    </script>
</body>

</html>